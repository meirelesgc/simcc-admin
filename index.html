<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Chat Autenticado</title>
</head>

<body>
    <h1>Login</h1>
    <form id="loginForm">
        <input type="text" id="email" placeholder="Email" required />
        <input type="password" id="password" placeholder="Senha" required />
        <button type="submit">Entrar</button>
    </form>

    <div id="chatSetup" style="display: none;">
        <h2>Iniciar Conversa</h2>
        <input type="text" id="receiverId" placeholder="ID do usuário para conversar" required />
        <button onclick="startChat()">Iniciar Chat</button>
    </div>

    <div id="chatSection" style="display: none;">
        <h2>Chat</h2>
        <form onsubmit="sendMessage(event)">
            <input type="text" id="messageText" autocomplete="off" />
            <button>Enviar</button>
        </form>
        <ul id="messages"></ul>
    </div>

    <script>
        let token = ''
        let ws = null
        let userId = null

        document.getElementById('loginForm').addEventListener('submit', async function (event) {
            event.preventDefault()

            const email = document.getElementById('email').value
            const password = document.getElementById('password').value

            const data = new URLSearchParams()
            data.append('username', email)
            data.append('password', password)

            const response = await fetch('http://localhost:8000/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: data
            })

            if (response.ok) {
                const result = await response.json()
                token = result.access_token

                // Decodificar o token para obter o user_id
                const payload = JSON.parse(atob(token.split('.')[1]))
                userId = payload.sub

                document.getElementById('loginForm').style.display = 'none'
                document.getElementById('chatSetup').style.display = 'block'
            } else {
                alert('Falha no login')
            }
        })

        function startChat() {
            const receiverId = document.getElementById('receiverId').value.trim()
            if (!receiverId) {
                alert("Informe o ID do usuário com quem deseja conversar.")
                return
            }

            ws = new WebSocket(`ws://localhost:8000/ws/chat/user/${receiverId}/?token=${token}`)

            ws.onopen = function () {
                document.getElementById('chatSetup').style.display = 'none'
                document.getElementById('chatSection').style.display = 'block'
            }

            ws.onmessage = function (event) {
                const messages = document.getElementById('messages')
                const message = document.createElement('li')
                message.textContent = event.data
                messages.appendChild(message)
            }

            ws.onclose = function () {
                alert("Conexão encerrada.")
                document.getElementById('chatSection').style.display = 'none'
            }

            ws.onerror = function (err) {
                console.error("Erro no WebSocket:", err)
            }
        }

        function sendMessage(event) {
            event.preventDefault()
            const input = document.getElementById("messageText")
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(input.value)
                input.value = ''
            } else {
                alert("WebSocket não está conectado.")
            }
        }
    </script>
</body>

</html>